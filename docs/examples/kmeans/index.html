<!DOCTYPE html><html lang="en-us"><head><link rel="shortcut icon" type="image/png" sizes="16x16" href="https://dsc-spidal.github.io/harp-test/img/favicon-16x9.png"><link rel="shortcut icon" type="image/png" sizes="32x32" href="https://dsc-spidal.github.io/harp-test/img/favicon-32x18.png"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hugo 0.18" /><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="harp"><meta property="og:image" content="/img/logo54x54.png"><meta property="og:url" content="https://dsc-spidal.github.io/harp-test/"><meta name="twitter:title" content="harp"><meta name="twitter:image" content="/img/0-1-1.png"><meta property="og:site_name" content="K-Means"><meta property="og:url" content="/docs/examples/kmeans/"><meta property="og:description" content=""><meta name="twitter:description" content=""><title>harp Documentation - K-Means</title><link rel="stylesheet" href="https://dsc-spidal.github.io/harp-test/css/style.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp-test/css/font-awesome.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp-test/css/pygments.css"></head><body><nav class="hn-top-navbar navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="hn-navbar-container container-fluid"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#hn-navbar" aria-controls="hn-navbar" aria-expanded="false"><span class="sr-only"><Toggle>navigation</Toggle></span><i class="hn-toggle-button fa fa-bars"></i></button><a class="hn-navbar-logo navbar-brand" href="https://dsc-spidal.github.io/harp-test/"><img class="pull-left" src="https://dsc-spidal.github.io/harp-test/img/0-1-2.png" width="62%"></a></div><div id="hn-navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="https://dsc-spidal.github.io/harp-test/docs/getting-started">Docs</a></li><li><a href="https://dsc-spidal.github.io/harp-test/api">API</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/resources">Resources</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/contributors/community">Community</a></li><li><a href="https://github.com/DSC-SPIDAL/harp-test/">GitHub</a></li><li><a href="https://groups.google.com/forum/#!forum/harp-users">Mailing List</a></li></ul></div></div></nav><div class="hn-main"><div class="container"><div class="row"><aside class="hn-sidebar hidden-xs col-sm-4 col-md-3 col-lg-2 collapse"><nav class="hn-sidebar-nav"><div id="hn-accordion" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="quick-start" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-quick-start" aria-labelledby="quick-start"><i class="fa fa-caret-right"></i>Quick Start</a></h4></section><div id="collapse-quick-start" class="panel-collapse collapse" aria-labelledby="quick-start"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/getting-started">Harp Installation (single)</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/getting-started-cluster">Harp Installation (cluster)</a></li></ul></div></div></div><div class="panel panel-default"><section id="programming-guides" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-programming-guides" aria-labelledby="programming-guides"><i class="fa fa-caret-right"></i>Programming Guides</a></h4></section><div id="collapse-programming-guides" class="panel-collapse collapse" aria-labelledby="programming-guides"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/programming/overview">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/programming/data-interface">Data Interfaces and Types</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/programming/scheduler">Schedulers</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/programming/computation-models">Computation Models</a></li></ul></div></div></div><div class="panel panel-default"><section id="collective-communication" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-collective-communication" aria-labelledby="collective-communication"><i class="fa fa-caret-right"></i>Collective Communication</a></h4></section><div id="collapse-collective-communication" class="panel-collapse collapse" aria-labelledby="collective-communication"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/broadcast">broadcast</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/reduce">reduce</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/allgather">allgather</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/allreduce">allreduce</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/regroup">regroup</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/pushandpull">push &amp; pull</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/rotate">rotate</a></li></ul></div></div></div><div class="panel panel-default"><section id="examples" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-examples" aria-labelledby="examples"><i class="fa fa-caret-right"></i>Examples</a></h4></section><div id="collapse-examples" class="panel-collapse collapse" aria-labelledby="examples"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/overview">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/kmeans">K-Means</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/mlrsgd">Multiclass Logistic Regression</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/lda">Latent Dirichlet Allocation (CVB)</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/svm">Support Vector Machine</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/rf">Random Forests</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/nn">Neural Network</a></li></ul></div></div></div><div class="panel panel-default"><section id="applications" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-applications" aria-labelledby="applications"><i class="fa fa-caret-right"></i>Applications</a></h4></section><div id="collapse-applications" class="panel-collapse collapse" aria-labelledby="applications"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/applications/lda-cgs">Latent Dirichlet Allocation (CGS)</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/applications/mf">Matrix Factorization</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-daal" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-daal" aria-labelledby="harp-daal"><i class="fa fa-caret-right"></i>Harp-DAAL</a></h4></section><div id="collapse-harp-daal" class="panel-collapse collapse" aria-labelledby="harp-daal"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/harpdaal/harpdaal">Harp-DAAL</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/harpdaal/mfsgd">Matrix Factorization (SGD)</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-resources" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-resources" aria-labelledby="harp-resources"><i class="fa fa-caret-right"></i>Harp Resources</a></h4></section><div id="collapse-harp-resources" class="panel-collapse collapse" aria-labelledby="harp-resources"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/resources">Harp Resources</a></li></ul></div></div></div><div class="panel panel-default"><section id="contributors" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-contributors" aria-labelledby="contributors"><i class="fa fa-caret-right"></i>Contributors</a></h4></section><div id="collapse-contributors" class="panel-collapse collapse" aria-labelledby="contributors"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/contributors/community">Community</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/contributors/contributors">Contributors</a></li></ul></div></div></div></div></nav></aside><section class="hn-docs-main col-sm-8 col-md-9 col-lg-10 col-sm-offset-4 col-md-offset-3 col-lg-offset-2"><header class="hn-docs-header page-header"><h1>K-Means</h1><div class="hn-docs-description"></div></header><article class="hn-docs-content">

<p><img src="https://dsc-spidal.github.io/harp-test/img/kmeans.png" width="80%" ></p>

<p>K-Means is a powerful and easily understood clustering algorithm. The aim of the algorithm is to divide a given set of points into <code>K</code> partitions. <code>K</code> needs to be specified by the user. In order to understand K-Means, first you need to understand the proceeding concepts and their meanings.</p>

<ul>
<li><p><code>Centroids</code>:
Centroids can be defined as the center of each cluster. If we are performing clustering with k=3, we will have 3 centroids. To perform K-Means clustering, the users needs to provide an initial set of centroids.</p></li>

<li><p><code>Distance</code>:
In order to group data points as close together or as far-apart, we need to define a distance between two given data points. In K-Means, clustering distance is normally calculated as the Euclidean Distance between two data points.</p></li>
</ul>

<p>The K-Means algorithm simply repeats the following set of steps until there is no change in the partition assignments. In that, it has clarified which data point is assigned to which partition.</p>

<ol>
<li><p>Choose K points as the initial set of centroids.</p></li>

<li><p>Assign each data point in the data set to the closest centroid (this is done by calculating the distance between the data point and each centroid).</p></li>

<li><p>Calculate the new centroids based on the clusters that were generated in step 2. Normally this is done by calculating the mean of each cluster.</p></li>

<li><p>Repeat step 2 and 3 until data points do not change cluster assignments, which means that their centroids are set.</p></li>
</ol>

<h2 id="parallel-design">PARALLEL DESIGN</h2>

<ul>
<li><p>What are the model? What kind of data structure?</p>

<p>Centroids of the clusters are model in vanilla kmeans. It has a vector structure as a double array.</p></li>

<li><p>What are the characteristics of the data dependency in model update computation, can updates run concurrently?</p>

<p>In the core model update computation, each data point should access all the model, compute distance with each centroid, find the nearest one and partially update model. The true update only occurs when all data points finish their search.</p></li>

<li><p>which kind of parallelism scheme is suitable, data parallelism or model parallelism?</p>

<p>Data parallelism can be used, i.e., calculating different data points in parallel.</p>

<p>For model parallelism, there are two different solutions.</p>

<pre><code>1. Without model parallelism, each node get one replica of the whole model, which updates locally in parallel, and then synchronizes when local computation all finish

2. With model parallelism, each node get one partition of the model, which updates in parallel, and then rotates to the neighbor node when local computation for all local data points finish. Repeat until each partition returns back to the original node, then do the final model update.
</code></pre></li>

<li><p>which collective communication operations is suitable to synchronize model?</p>

<p>For solution without model parallelism, Synchronize replicas of the model by allreduce, then calculate the new centroids and go to the next iteration. For vanilla kmeans, the combination of reduce/broadcast, push/pull, regroup/allgather are similar to allreduce.</p>

<p>For solution with model parallelism, there is no replica exists, but the movement of the model partitions are a kind of synchronized collective operation, supported in Harp by an abstraction of rotate.</p></li>
</ul>

<h2 id="dataflow">DATAFLOW</h2>

<p><img src="https://dsc-spidal.github.io/harp-test/img/4-2-2.png" alt="dataflow" /></p>

<h2 id="step-1-the-main-method">Step 1 &mdash; The Main Method</h2>

<p>The tasks of the main class is to configure and run the job iteratively.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">generate</span> <span class="n">N</span> <span class="n">data</span> <span class="nf">points</span> <span class="o">(</span><span class="n">D</span> <span class="n">dimensions</span><span class="o">),</span> <span class="n">write</span> <span class="n">to</span> <span class="n">HDFS</span>
<span class="n">generate</span> <span class="n">M</span> <span class="n">centroids</span><span class="o">,</span> <span class="n">write</span> <span class="n">to</span> <span class="n">HDFS</span>
<span class="k">for</span> <span class="n">iterations</span><span class="o">{</span>
    <span class="n">configure</span> <span class="n">a</span> <span class="n">job</span>
    <span class="n">launch</span> <span class="n">the</span> <span class="n">job</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="step-2-the-mapcollective-function">Step 2 &mdash; The mapCollective function</h2>

<p>This is the definition of map-collective task. It reads data from context and then call runKmeans function to actually run kmeans Mapper task.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">mapCollective</span><span class="o">(</span> <span class="n">KeyValReader</span> <span class="n">reader</span><span class="o">,</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
    <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Start collective mapper.&quot;</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">pointFiles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">nextKeyValue</span><span class="o">())</span> <span class="o">{</span>
	   	<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">getCurrentKey</span><span class="o">();</span>
	   	<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">getCurrentValue</span><span class="o">();</span>
    	<span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Key: &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&quot;, Value: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
	    <span class="n">pointFiles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="n">Configuration</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">();</span>
	<span class="n">runKmeans</span><span class="o">(</span><span class="n">pointFiles</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
    <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Total iterations in master view: &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="step-3-the-runkmeans-function">Step 3 &mdash; The runKmeans function</h2>

<p>Harp provides several collective communication operations. Here are some examples provided to show how to apply these collective communication methods to K-Means.</p>

<p><ul class="nav nav-pills">
    <li class="active"><a data-toggle="pill" href="#allreduce">Allreduce</a></li>
    <li><a data-toggle="pill" href="#broadcast-reduce">Broadcast-Reduce</a></li>
    <li><a data-toggle="pill" href="#push-pull">Push-Pull</a></li>
    <li><a data-toggle="pill" href="#regroup-allgather">Regroup-Allgather</a></li>
  </ul></p>

<p><div class="tab-content">
    <div id="allreduce" class="tab-pane fade in active">
      <h4>Use AllReduce collective communication to do synchronization</h4>
      <div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #3976cc">private</span> <span style="color: #3976cc">void</span> <span style="color: #02a894">runKmeans</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">List</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">String</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">fileNames</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">Configuration</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">Context</span> <span style="color: #6b6b6b">context</span><span style="color: #c03221">)</span> <span style="color: #3976cc">throws</span> <span style="color: #6b6b6b">IOException</span> <span style="color: #c03221">{</span>
      <span style="color: #03254e">// &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</span>
      <span style="color: #03254e">// Load centroids</span>
      <span style="color: #03254e">//for every partition in the centoid table, we will use the last element to store the number of points </span>
      <span style="color: #03254e">// which are clustered to the particular partitionID</span>
      <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">cenTable</span> <span style="color: #c03221">=</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;&gt;(</span><span style="color: #7d518c">0</span><span style="color: #c03221">,</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">DoubleArrPlus</span><span style="color: #c03221">());</span>
      <span style="color: #3976cc">if</span> <span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">isMaster</span><span style="color: #c03221">())</span> <span style="color: #c03221">{</span>
            <span style="color: #6b6b6b">loadCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">vectorSize</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">.</span><span style="color: #02a894">get</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">KMeansConstants</span><span style="color: #c03221">.</span><span style="color: #02a894">CFILE</span><span style="color: #c03221">),</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">);</span>
      <span style="color: #c03221">}</span>
      <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;After loading centroids&quot;</span><span style="color: #c03221">);</span>
      <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
      <span style="color: #03254e">//broadcast centroids</span>
      <span style="color: #6b6b6b">broadcastCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
      <span style="color: #03254e">//after broadcasting</span>
      <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;After brodcasting centroids&quot;</span><span style="color: #c03221">);</span>
      <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
      <span style="color: #03254e">//load data </span>
      <span style="color: #6b6b6b">ArrayList</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">dataPoints</span> <span style="color: #c03221">=</span> <span style="color: #6b6b6b">loadData</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">fileNames</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">vectorSize</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">);</span>
      <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">previousCenTable</span> <span style="color: #c03221">=</span>  <span style="color: #3976cc">null</span><span style="color: #c03221">;</span>
      <span style="color: #03254e">//iterations</span>
      <span style="color: #3976cc">for</span><span style="color: #c03221">(</span><span style="color: #3976cc">int</span> <span style="color: #6b6b6b">iter</span><span style="color: #c03221">=</span><span style="color: #7d518c">0</span><span style="color: #c03221">;</span> <span style="color: #6b6b6b">iter</span> <span style="color: #c03221">&lt;</span> <span style="color: #6b6b6b">iteration</span><span style="color: #c03221">;</span> <span style="color: #6b6b6b">iter</span><span style="color: #c03221">++){</span>
            <span style="color: #6b6b6b">previousCenTable</span> <span style="color: #c03221">=</span>  <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">;</span>
            <span style="color: #6b6b6b">cenTable</span> <span style="color: #c03221">=</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;&gt;(</span><span style="color: #7d518c">0</span><span style="color: #c03221">,</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">DoubleArrPlus</span><span style="color: #c03221">());</span>
            <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;Iteraton No.&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">);</span>
            <span style="color: #03254e">//compute new partial centroid table using previousCenTable and data points</span>
            <span style="color: #6b6b6b">computation</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">previousCenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">dataPoints</span><span style="color: #c03221">);</span>
            <span style="color: #03254e">//AllReduce; </span>
            <span style="color: #03254e">/*************************************<strong><em>/</span>
            <span style="color: #6b6b6b">allreduce</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;main&quot;</span><span style="color: #c03221">,</span> <span style="color: #9b802e">&quot;allreduce_&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
            <span style="color: #03254e">//we can calculate new centroids</span>
            <span style="color: #6b6b6b">calculateCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
            <span style="color: #03254e">/</em></strong>*************************************/</span>
            <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
        <span style="color: #c03221">}</span>
        <span style="color: #03254e">//output results</span>
     <span style="color: #3976cc">if</span><span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">isMaster</span><span style="color: #c03221">()){</span>
        <span style="color: #6b6b6b">outputCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span>  <span style="color: #6b6b6b">conf</span><span style="color: #c03221">,</span>   <span style="color: #6b6b6b">context</span><span style="color: #c03221">);</span>
      <span style="color: #c03221">}</span>
<span style="color: #c03221">}</span>
 </pre></div>
    </div>
    <div id="broadcast-reduce" class="tab-pane fade">
      <h4>Use broadcast and reduce collective communication to do synchronization</h4></p>

<p>The video below is the step by step guide on how this collective communication works for K-means. The data is partitions into K different partitions with K centroids. Data is then broadcasted to all the different partitions. And the centroids for each of the partition is grouped together and sent to the master node.</p>

<p><p>Once all the local centroids from the partition is collected in the global centroid table, the updated table is transferred to the root node and then broadcasted again. This step keeps repeating itself till the convergence is reached.
</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #3976cc">private</span> <span style="color: #3976cc">void</span> <span style="color: #02a894">runKmeans</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">List</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">String</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">fileNames</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">Configuration</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">Context</span> <span style="color: #6b6b6b">context</span><span style="color: #c03221">)</span> <span style="color: #3976cc">throws</span> <span style="color: #6b6b6b">IOException</span> <span style="color: #c03221">{</span>
     <span style="color: #03254e">// &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</span>
     <span style="color: #03254e">// Load centroids</span>
     <span style="color: #03254e">//for every partition in the centoid table, we will use the last element to store the number of points </span>
     <span style="color: #03254e">// which are clustered to the particular partitionID</span>
     <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">cenTable</span> <span style="color: #c03221">=</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;&gt;(</span><span style="color: #7d518c">0</span><span style="color: #c03221">,</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">DoubleArrPlus</span><span style="color: #c03221">());</span>
     <span style="color: #3976cc">if</span> <span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">isMaster</span><span style="color: #c03221">())</span> <span style="color: #c03221">{</span>
        <span style="color: #6b6b6b">loadCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">vectorSize</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">.</span><span style="color: #02a894">get</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">KMeansConstants</span><span style="color: #c03221">.</span><span style="color: #02a894">CFILE</span><span style="color: #c03221">),</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">);</span>
     <span style="color: #c03221">}</span>
     <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;After loading centroids&quot;</span><span style="color: #c03221">);</span>
     <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
     <span style="color: #03254e">//broadcast centroids</span>
     <span style="color: #6b6b6b">broadcastCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
     <span style="color: #03254e">//after broadcasting</span>
     <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;After brodcasting centroids&quot;</span><span style="color: #c03221">);</span>
     <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
     <span style="color: #03254e">//load data </span>
     <span style="color: #6b6b6b">ArrayList</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">dataPoints</span> <span style="color: #c03221">=</span> <span style="color: #6b6b6b">loadData</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">fileNames</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">vectorSize</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">);</span>
     <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">previousCenTable</span> <span style="color: #c03221">=</span>  <span style="color: #3976cc">null</span><span style="color: #c03221">;</span>
     <span style="color: #03254e">//iterations</span>
     <span style="color: #3976cc">for</span><span style="color: #c03221">(</span><span style="color: #3976cc">int</span> <span style="color: #6b6b6b">iter</span><span style="color: #c03221">=</span><span style="color: #7d518c">0</span><span style="color: #c03221">;</span> <span style="color: #6b6b6b">iter</span> <span style="color: #c03221">&lt;</span> <span style="color: #6b6b6b">iteration</span><span style="color: #c03221">;</span> <span style="color: #6b6b6b">iter</span><span style="color: #c03221">++){</span>
        <span style="color: #6b6b6b">previousCenTable</span> <span style="color: #c03221">=</span>  <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">;</span>
        <span style="color: #6b6b6b">cenTable</span> <span style="color: #c03221">=</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;&gt;(</span><span style="color: #7d518c">0</span><span style="color: #c03221">,</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">DoubleArrPlus</span><span style="color: #c03221">());</span>
        <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;Iteraton No.&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">);</span>
        <span style="color: #03254e">//compute new partial centroid table using previousCenTable and data points</span>
        <span style="color: #6b6b6b">computation</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">previousCenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">dataPoints</span><span style="color: #c03221">);</span>
        <span style="color: #03254e">/*************************************<strong><em>/</span>
        <span style="color: #6b6b6b">reduce</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;main&quot;</span><span style="color: #c03221">,</span> <span style="color: #9b802e">&quot;reduce<em>&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">getMasterID</span><span style="color: #c03221">());</span>
        <span style="color: #3976cc">if</span><span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">isMaster</span><span style="color: #c03221">())</span>
            <span style="color: #6b6b6b">calculateCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
        <span style="color: #6b6b6b">broadcast</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;main&quot;</span><span style="color: #c03221">,</span> <span style="color: #9b802e">&quot;bcast</em>&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">getMasterID</span><span style="color: #c03221">(),</span> <span style="color: #3976cc">false</span><span style="color: #c03221">);</span>
        <span style="color: #03254e">/</em></strong>**********************************<strong><em>/</span>
        <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
    <span style="color: #c03221">}</span>
        <span style="color: #03254e">//output results</span>
    <span style="color: #3976cc">if</span><span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">isMaster</span><span style="color: #c03221">()){</span>
        <span style="color: #6b6b6b">outputCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span>  <span style="color: #6b6b6b">conf</span><span style="color: #c03221">,</span>   <span style="color: #6b6b6b">context</span><span style="color: #c03221">);</span>
    <span style="color: #c03221">}</span>
<span style="color: #c03221">}</span>
     </pre></div>
     </div>
    <div id="push-pull" class="tab-pane fade">
      <h4>Use push and pull collective communication to do synchronization</h4>
    <div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #3976cc">private</span> <span style="color: #3976cc">void</span> <span style="color: #02a894">runKmeans</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">List</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">String</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">fileNames</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">Configuration</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">Context</span> <span style="color: #6b6b6b">context</span><span style="color: #c03221">)</span> <span style="color: #3976cc">throws</span> <span style="color: #6b6b6b">IOException</span> <span style="color: #c03221">{</span>
          <span style="color: #03254e">// &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</span>
          <span style="color: #03254e">// Load centroids</span>
          <span style="color: #03254e">//for every partition in the centoid table, we will use the last element to store the number of points </span>
          <span style="color: #03254e">// which are clustered to the particular partitionID</span>
          <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">cenTable</span> <span style="color: #c03221">=</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;&gt;(</span><span style="color: #7d518c">0</span><span style="color: #c03221">,</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">DoubleArrPlus</span><span style="color: #c03221">());</span>
          <span style="color: #3976cc">if</span> <span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">isMaster</span><span style="color: #c03221">())</span> <span style="color: #c03221">{</span>
              <span style="color: #6b6b6b">loadCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">vectorSize</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">.</span><span style="color: #02a894">get</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">KMeansConstants</span><span style="color: #c03221">.</span><span style="color: #02a894">CFILE</span><span style="color: #c03221">),</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">);</span>
          <span style="color: #c03221">}</span>
          <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;After loading centroids&quot;</span><span style="color: #c03221">);</span>
          <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
          <span style="color: #03254e">//broadcast centroids</span>
          <span style="color: #6b6b6b">broadcastCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
          <span style="color: #03254e">//after broadcasting</span>
          <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;After brodcasting centroids&quot;</span><span style="color: #c03221">);</span>
          <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
          <span style="color: #03254e">//load data </span>
          <span style="color: #6b6b6b">ArrayList</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">dataPoints</span> <span style="color: #c03221">=</span> <span style="color: #6b6b6b">loadData</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">fileNames</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">vectorSize</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">);</span>
          <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">globalTable</span> <span style="color: #c03221">=</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;(</span><span style="color: #7d518c">0</span><span style="color: #c03221">,</span>  <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">DoubleArrPlus</span><span style="color: #c03221">());</span>
          <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">previousCenTable</span> <span style="color: #c03221">=</span>  <span style="color: #3976cc">null</span><span style="color: #c03221">;</span>
          <span style="color: #03254e">//iterations</span>
          <span style="color: #3976cc">for</span><span style="color: #c03221">(</span><span style="color: #3976cc">int</span> <span style="color: #6b6b6b">iter</span><span style="color: #c03221">=</span><span style="color: #7d518c">0</span><span style="color: #c03221">;</span> <span style="color: #6b6b6b">iter</span> <span style="color: #c03221">&lt;</span> <span style="color: #6b6b6b">iteration</span><span style="color: #c03221">;</span> <span style="color: #6b6b6b">iter</span><span style="color: #c03221">++){</span>
              <span style="color: #03254e">// clean contents in the table.</span>
              <span style="color: #6b6b6b">globalTable</span><span style="color: #c03221">.</span><span style="color: #02a894">release</span><span style="color: #c03221">();</span>
              <span style="color: #6b6b6b">previousCenTable</span> <span style="color: #c03221">=</span>  <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">;</span>
              <span style="color: #6b6b6b">cenTable</span> <span style="color: #c03221">=</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;&gt;(</span><span style="color: #7d518c">0</span><span style="color: #c03221">,</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">DoubleArrPlus</span><span style="color: #c03221">());</span>
              <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;Iteraton No.&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">);</span>
              <span style="color: #03254e">//compute new partial centroid table using previousCenTable and data points</span>
              <span style="color: #6b6b6b">computation</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">previousCenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">dataPoints</span><span style="color: #c03221">);</span>
              <span style="color: #03254e">/</em></strong>**********************************<strong><em>/</span>
              <span style="color: #6b6b6b">push</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;main&quot;</span><span style="color: #c03221">,</span> <span style="color: #9b802e">&quot;push<em>&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">globalTable</span> <span style="color: #c03221">,</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Partitioner</span><span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">getNumWorkers</span><span style="color: #c03221">()));</span>
              <span style="color: #03254e">//we can calculate new centroids</span>
              <span style="color: #6b6b6b">calculateCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">globalTable</span><span style="color: #c03221">);</span>
              <span style="color: #6b6b6b">pull</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;main&quot;</span><span style="color: #c03221">,</span> <span style="color: #9b802e">&quot;pull</em>&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">globalTable</span><span style="color: #c03221">,</span> <span style="color: #3976cc">true</span><span style="color: #c03221">);</span>
              <span style="color: #03254e">/</em></strong>**********************************<strong><em>/</span>
              <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
          <span style="color: #c03221">}</span>
          <span style="color: #03254e">//output results</span>
          <span style="color: #3976cc">if</span><span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">isMaster</span><span style="color: #c03221">()){</span>
              <span style="color: #6b6b6b">outputCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span>  <span style="color: #6b6b6b">conf</span><span style="color: #c03221">,</span>   <span style="color: #6b6b6b">context</span><span style="color: #c03221">);</span>
          <span style="color: #c03221">}</span>
     <span style="color: #c03221">}</span>
</pre></div>
    </div>
    <div id="regroup-allgather" class="tab-pane fade">
      <h3>Use Regroup and allgather collective communication to do synchronization</h3>
    <div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #3976cc">private</span> <span style="color: #3976cc">void</span> <span style="color: #02a894">runKmeans</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">List</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">String</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">fileNames</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">Configuration</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">Context</span> <span style="color: #6b6b6b">context</span><span style="color: #c03221">)</span> <span style="color: #3976cc">throws</span> <span style="color: #6b6b6b">IOException</span> <span style="color: #c03221">{</span>
          <span style="color: #03254e">// &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</span>
          <span style="color: #03254e">// Load centroids</span>
          <span style="color: #03254e">//for every partition in the centoid table, we will use the last element to store the number of points </span>
          <span style="color: #03254e">// which are clustered to the particular partitionID</span>
          <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">cenTable</span> <span style="color: #c03221">=</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;&gt;(</span><span style="color: #7d518c">0</span><span style="color: #c03221">,</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">DoubleArrPlus</span><span style="color: #c03221">());</span>
          <span style="color: #3976cc">if</span> <span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">isMaster</span><span style="color: #c03221">())</span> <span style="color: #c03221">{</span>
              <span style="color: #6b6b6b">loadCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">vectorSize</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">.</span><span style="color: #02a894">get</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">KMeansConstants</span><span style="color: #c03221">.</span><span style="color: #02a894">CFILE</span><span style="color: #c03221">),</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">);</span>
          <span style="color: #c03221">}</span>
          <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;After loading centroids&quot;</span><span style="color: #c03221">);</span>
          <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
          <span style="color: #03254e">//broadcast centroids</span>
          <span style="color: #6b6b6b">broadcastCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
          <span style="color: #03254e">//after broadcasting</span>
          <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;After brodcasting centroids&quot;</span><span style="color: #c03221">);</span>
          <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
          <span style="color: #03254e">//load data </span>
          <span style="color: #6b6b6b">ArrayList</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">dataPoints</span> <span style="color: #c03221">=</span> <span style="color: #6b6b6b">loadData</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">fileNames</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">vectorSize</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">conf</span><span style="color: #c03221">);</span>
          <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;</span><span style="color: #6b6b6b">DoubleArray</span><span style="color: #c03221">&gt;</span> <span style="color: #6b6b6b">previousCenTable</span> <span style="color: #c03221">=</span>  <span style="color: #3976cc">null</span><span style="color: #c03221">;</span>
          <span style="color: #03254e">//iterations</span>
          <span style="color: #3976cc">for</span><span style="color: #c03221">(</span><span style="color: #3976cc">int</span> <span style="color: #6b6b6b">iter</span><span style="color: #c03221">=</span><span style="color: #7d518c">0</span><span style="color: #c03221">;</span> <span style="color: #6b6b6b">iter</span> <span style="color: #c03221">&lt;</span> <span style="color: #6b6b6b">iteration</span><span style="color: #c03221">;</span> <span style="color: #6b6b6b">iter</span><span style="color: #c03221">++){</span>
              <span style="color: #6b6b6b">previousCenTable</span> <span style="color: #c03221">=</span>  <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">;</span>
              <span style="color: #6b6b6b">cenTable</span> <span style="color: #c03221">=</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">Table</span><span style="color: #c03221">&lt;&gt;(</span><span style="color: #7d518c">0</span><span style="color: #c03221">,</span> <span style="color: #3976cc">new</span> <span style="color: #6b6b6b">DoubleArrPlus</span><span style="color: #c03221">());</span>
              <span style="color: #6b6b6b">System</span><span style="color: #c03221">.</span><span style="color: #02a894">out</span><span style="color: #c03221">.</span><span style="color: #02a894">println</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;Iteraton No.&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">);</span>
              <span style="color: #03254e">//compute new partial centroid table using previousCenTable and data points</span>
              <span style="color: #6b6b6b">computation</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">previousCenTable</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">dataPoints</span><span style="color: #c03221">);</span>
              <span style="color: #03254e">/</em></strong>**********************************<strong><em>/</span>
              <span style="color: #03254e">//regroup and allgather to synchronized centroids</span>
              <span style="color: #6b6b6b">regroup</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;main&quot;</span><span style="color: #c03221">,</span> <span style="color: #9b802e">&quot;regroup<em>&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span> <span style="color: #3976cc">null</span><span style="color: #c03221">);</span>
              <span style="color: #03254e">//we can calculate new centroids</span>
              <span style="color: #6b6b6b">calculateCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
              <span style="color: #6b6b6b">allgather</span><span style="color: #c03221">(</span><span style="color: #9b802e">&quot;main&quot;</span><span style="color: #c03221">,</span> <span style="color: #9b802e">&quot;allgather</em>&quot;</span><span style="color: #c03221">+</span><span style="color: #6b6b6b">iter</span><span style="color: #c03221">,</span> <span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
              <span style="color: #03254e">/</em></strong>*************************************/</span>
              <span style="color: #6b6b6b">printTable</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">);</span>
          <span style="color: #c03221">}</span>
          <span style="color: #03254e">//output results</span>
          <span style="color: #3976cc">if</span><span style="color: #c03221">(</span><span style="color: #3976cc">this</span><span style="color: #c03221">.</span><span style="color: #02a894">isMaster</span><span style="color: #c03221">()){</span>
              <span style="color: #6b6b6b">outputCentroids</span><span style="color: #c03221">(</span><span style="color: #6b6b6b">cenTable</span><span style="color: #c03221">,</span>  <span style="color: #6b6b6b">conf</span><span style="color: #c03221">,</span>   <span style="color: #6b6b6b">context</span><span style="color: #c03221">);</span>
          <span style="color: #c03221">}</span>
     <span style="color: #c03221">}</span>
</pre></div>
   </div>
  </div></p>

<h2 id="step-4-compute-local-centroids">Step 4 &mdash; Compute local centroids</h2>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">computation</span><span class="o">(</span><span class="n">Table</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="n">cenTable</span><span class="o">,</span> <span class="n">Table</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="n">previousCenTable</span><span class="o">,</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="n">dataPoints</span><span class="o">){</span>
    <span class="kt">double</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span><span class="o">(</span><span class="n">DoubleArray</span> <span class="n">aPoint</span><span class="o">:</span> <span class="n">dataPoints</span><span class="o">){</span>
    <span class="c1">//for each data point, find the nearest centroid</span>
        <span class="kt">double</span> <span class="n">minDist</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">tempDist</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">nearestPartitionID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Partition</span> <span class="n">ap</span><span class="o">:</span> <span class="n">previousCenTable</span><span class="o">.</span><span class="na">getPartitions</span><span class="o">()){</span>
            <span class="n">DoubleArray</span> <span class="n">aCentroid</span> <span class="o">=</span> <span class="o">(</span><span class="n">DoubleArray</span><span class="o">)</span> <span class="n">ap</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="n">tempDist</span> <span class="o">=</span> <span class="n">calcEucDistSquare</span><span class="o">(</span><span class="n">aPoint</span><span class="o">,</span> <span class="n">aCentroid</span><span class="o">,</span> <span class="n">vectorSize</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">minDist</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">tempDist</span> <span class="o">&lt;</span> <span class="n">minDist</span><span class="o">){</span>
                <span class="n">minDist</span> <span class="o">=</span> <span class="n">tempDist</span><span class="o">;</span>
                <span class="n">nearestPartitionID</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="na">id</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">err</span><span class="o">+=</span><span class="n">minDist</span><span class="o">;</span>

        <span class="c1">//for the certain data point, found the nearest centroid.</span>
        <span class="c1">// add the data to a new cenTable.</span>
        <span class="kt">double</span><span class="o">[]</span> <span class="n">partial</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="n">vectorSize</span><span class="o">+</span><span class="mi">1</span><span class="o">];</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">vectorSize</span><span class="o">;</span> <span class="n">j</span><span class="o">++){</span>
            <span class="n">partial</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">aPoint</span><span class="o">.</span><span class="na">get</span><span class="o">()[</span><span class="n">j</span><span class="o">];</span>
        <span class="o">}</span>
        <span class="n">partial</span><span class="o">[</span><span class="n">vectorSize</span><span class="o">]=</span><span class="mi">1</span><span class="o">;</span>

        <span class="k">if</span><span class="o">(</span><span class="n">cenTable</span><span class="o">.</span><span class="na">getPartition</span><span class="o">(</span><span class="n">nearestPartitionID</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">Partition</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="n">tmpAp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Partition</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;(</span><span class="n">nearestPartitionID</span><span class="o">,</span> <span class="k">new</span> <span class="n">DoubleArray</span><span class="o">(</span><span class="n">partial</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">vectorSize</span><span class="o">+</span><span class="mi">1</span><span class="o">));</span>
            <span class="n">cenTable</span><span class="o">.</span><span class="na">addPartition</span><span class="o">(</span><span class="n">tmpAp</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
             <span class="n">Partition</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="n">apInCenTable</span> <span class="o">=</span> <span class="n">cenTable</span><span class="o">.</span><span class="na">getPartition</span><span class="o">(</span><span class="n">nearestPartitionID</span><span class="o">);</span>
             <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vectorSize</span> <span class="o">+</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
             <span class="n">apInCenTable</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">get</span><span class="o">()[</span><span class="n">i</span><span class="o">]</span> <span class="o">+=</span> <span class="n">partial</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
             <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Errors: &quot;</span><span class="o">+</span><span class="n">err</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="step-5-calculate-new-centroids">Step 5 &mdash; Calculate new centroids</h2>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">calculateCentroids</span><span class="o">(</span> <span class="n">Table</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="n">cenTable</span><span class="o">){</span>
    <span class="k">for</span><span class="o">(</span> <span class="n">Partition</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="n">partialCenTable</span><span class="o">:</span> <span class="n">cenTable</span><span class="o">.</span><span class="na">getPartitions</span><span class="o">()){</span>
        <span class="kt">double</span><span class="o">[]</span> <span class="n">doubles</span> <span class="o">=</span> <span class="n">partialCenTable</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">get</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">vectorSize</span><span class="o">;</span> <span class="n">h</span><span class="o">++){</span>
            <span class="n">doubles</span><span class="o">[</span><span class="n">h</span><span class="o">]</span> <span class="o">/=</span> <span class="n">doubles</span><span class="o">[</span><span class="n">vectorSize</span><span class="o">];</span>
        <span class="o">}</span>
        <span class="n">doubles</span><span class="o">[</span><span class="n">vectorSize</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;after calculate new centroids&quot;</span><span class="o">);</span>
    <span class="n">printTable</span><span class="o">(</span><span class="n">cenTable</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="compile">COMPILE</h2>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">cd</span> <span class="nv">$HARP_ROOT_DIR</span>
mvn clean package
<span class="nb">cd</span> <span class="nv">$HARP_ROOT_DIR</span>/harp-tutorial-app
cp target/harp-tutorial-app-1.0-SNAPSHOT.jar <span class="nv">$HADOOP_HOME</span>
<span class="nb">cd</span> <span class="nv">$HADOOP_HOME</span>
</code></pre></div>

<h2 id="usage">USAGE</h2>

<p>Run Harp K-Means:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>hadoop jar harp-tutorial-app-1.0-SNAPSHOT.jar edu.iu.kmeans.common.KmeansMapCollective &lt;numOfDataPoints&gt; &lt;num of Centroids&gt; &lt;size of vector&gt; &lt;number of map tasks&gt; &lt;number of iteration&gt; &lt;workDir&gt; &lt;localDir&gt; &lt;communication operation&gt;

   &lt;numOfDataPoints&gt;: the number of data points you want to generate randomly
   &lt;num of centriods&gt;: the number of centroids you want to clustering the data to
   &lt;size of vector&gt;: the number of dimension of the data
   &lt;number of map tasks&gt;: number of map tasks
   &lt;number of iteration&gt;: the number of iterations to run
   &lt;work dir&gt;: the root directory <span class="k">for</span> this running in HDFS
   &lt;<span class="nb">local</span> dir&gt;: the harp kmeans will firstly generate files which contain data points to <span class="nb">local</span> directory. Set this argument to determine the <span class="nb">local</span> directory.
   &lt;communication operation&gt; includes:
		<span class="o">[</span>allreduce<span class="o">]</span>: use allreduce operation to synchronize centroids
		<span class="o">[</span>regroup-allgather<span class="o">]</span>: use regroup and allgather operation to synchronize centroids
		<span class="o">[</span>broadcast-reduce<span class="o">]</span>: use broadcast and reduce operation to synchronize centroids
		<span class="o">[</span>push-pull<span class="o">]</span>: use push and pull operation to synchronize centroids
</code></pre></div>

<p>For example:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>hadoop jar harp-tutorial-app-1.0-SNAPSHOT.jar edu.iu.kmeans.common.KmeansMapCollective <span class="m">1000</span> <span class="m">10</span> <span class="m">10</span> <span class="m">2</span> <span class="m">10</span> /kmeans /tmp/kmeans allreduce
</code></pre></div>

<p>Fetch the results:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>hdfs dfs -ls /
hdfs dfs -cat /kmeans/centroids/*
</code></pre></div>
</article></section></div></div></div><script src="https://code.jquery.com/jquery-2.2.1.min.js"></script><script src="https://dsc-spidal.github.io/harp-test/js/app.min.js"></script></body></html>
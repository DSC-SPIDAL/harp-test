<!DOCTYPE html><html lang="en-us"><head><link rel="shortcut icon" type="image/png" sizes="16x16" href="https://dsc-spidal.github.io/harp-test/img/favicon-16x9.png"><link rel="shortcut icon" type="image/png" sizes="32x32" href="https://dsc-spidal.github.io/harp-test/img/favicon-32x18.png"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hugo 0.18" /><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="harp"><meta property="og:image" content="/img/logo54x54.png"><meta property="og:url" content="https://dsc-spidal.github.io/harp-test/"><meta name="twitter:title" content="harp"><meta name="twitter:image" content="/img/0-1-1.png"><meta property="og:site_name" content="Harp Neural Network"><meta property="og:url" content="/docs/examples/nn/"><meta property="og:description" content=""><meta name="twitter:description" content=""><title>harp Documentation - Harp Neural Network</title><link rel="stylesheet" href="https://dsc-spidal.github.io/harp-test/css/style.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp-test/css/font-awesome.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp-test/css/pygments.css"></head><body><nav class="hn-top-navbar navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="hn-navbar-container container-fluid"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#hn-navbar" aria-controls="hn-navbar" aria-expanded="false"><span class="sr-only"><Toggle>navigation</Toggle></span><i class="hn-toggle-button fa fa-bars"></i></button><a class="hn-navbar-logo navbar-brand" href="https://dsc-spidal.github.io/harp-test/"><img class="pull-left" src="https://dsc-spidal.github.io/harp-test/img/0-1-2.png" width="62%"></a></div><div id="hn-navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="https://dsc-spidal.github.io/harp-test/docs/getting-started">Docs</a></li><li><a href="https://dsc-spidal.github.io/harp-test/api">API</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/resources">Resources</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/contributors/community">Community</a></li><li><a href="https://github.com/DSC-SPIDAL/harp-test/">GitHub</a></li><li><a href="https://groups.google.com/forum/#!forum/harp-users">Mailing List</a></li></ul></div></div></nav><div class="hn-main"><div class="container"><div class="row"><aside class="hn-sidebar hidden-xs col-sm-4 col-md-3 col-lg-2 collapse"><nav class="hn-sidebar-nav"><div id="hn-accordion" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="quick-start" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-quick-start" aria-labelledby="quick-start"><i class="fa fa-caret-right"></i>Quick Start</a></h4></section><div id="collapse-quick-start" class="panel-collapse collapse" aria-labelledby="quick-start"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/getting-started">Harp Installation (single)</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/getting-started-cluster">Harp Installation (cluster)</a></li></ul></div></div></div><div class="panel panel-default"><section id="programming-guides" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-programming-guides" aria-labelledby="programming-guides"><i class="fa fa-caret-right"></i>Programming Guides</a></h4></section><div id="collapse-programming-guides" class="panel-collapse collapse" aria-labelledby="programming-guides"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/programming/overview">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/programming/data-interface">Data Interfaces and Types</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/programming/scheduler">Schedulers</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/programming/computation-models">Computation Models</a></li></ul></div></div></div><div class="panel panel-default"><section id="collective-communication" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-collective-communication" aria-labelledby="collective-communication"><i class="fa fa-caret-right"></i>Collective Communication</a></h4></section><div id="collapse-collective-communication" class="panel-collapse collapse" aria-labelledby="collective-communication"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/broadcast">broadcast</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/reduce">reduce</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/allgather">allgather</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/allreduce">allreduce</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/regroup">regroup</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/pushandpull">push &amp; pull</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/communications/rotate">rotate</a></li></ul></div></div></div><div class="panel panel-default"><section id="examples" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-examples" aria-labelledby="examples"><i class="fa fa-caret-right"></i>Examples</a></h4></section><div id="collapse-examples" class="panel-collapse collapse" aria-labelledby="examples"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/overview">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/kmeans">K-Means</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/mlrsgd">Multiclass Logistic Regression</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/lda">Latent Dirichlet Allocation (CVB)</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/svm">Support Vector Machine</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/rf">Random Forests</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/examples/nn">Neural Network</a></li></ul></div></div></div><div class="panel panel-default"><section id="applications" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-applications" aria-labelledby="applications"><i class="fa fa-caret-right"></i>Applications</a></h4></section><div id="collapse-applications" class="panel-collapse collapse" aria-labelledby="applications"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/applications/lda-cgs">Latent Dirichlet Allocation (CGS)</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/applications/mf">Matrix Factorization</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-daal" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-daal" aria-labelledby="harp-daal"><i class="fa fa-caret-right"></i>Harp-DAAL</a></h4></section><div id="collapse-harp-daal" class="panel-collapse collapse" aria-labelledby="harp-daal"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/harpdaal/harpdaal">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/harpdaal/mfsgd">Matrix Factorization (SGD)</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-resources" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-resources" aria-labelledby="harp-resources"><i class="fa fa-caret-right"></i>Harp Resources</a></h4></section><div id="collapse-harp-resources" class="panel-collapse collapse" aria-labelledby="harp-resources"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/resources">Harp Resources</a></li></ul></div></div></div><div class="panel panel-default"><section id="contributors" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-contributors" aria-labelledby="contributors"><i class="fa fa-caret-right"></i>Contributors</a></h4></section><div id="collapse-contributors" class="panel-collapse collapse" aria-labelledby="contributors"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp-test/docs/contributors/community">Community</a></li><li><a href="https://dsc-spidal.github.io/harp-test/docs/contributors/contributors">Contributors</a></li></ul></div></div></div></div></nav></aside><section class="hn-docs-main col-sm-8 col-md-9 col-lg-10 col-sm-offset-4 col-md-offset-3 col-lg-offset-2"><header class="hn-docs-header page-header"><h1>Harp Neural Network</h1><div class="hn-docs-description"></div></header><article class="hn-docs-content">

<p><img src="https://dsc-spidal.github.io/harp-test/img/nn.png" width="60%"  ></p>

<p>Neural networks are a set of algorithms, which is based on a large of neural units. Each neural unit is connected with many others, and forms a network structure. Computation happens in the neural unit, which combines all the inputs with a set of coefficients, or weights, and gives an output by an activation function. A layer is a group of neural units, that each layer’s output is the subsequent layer’s input. A learning algorithm tries to learn the weights from data, and then the network can be used to recognize patterns.</p>

<p>Here, we give a simple tutorial on how to parallel a standard implementation of the <a href="https://en.wikipedia.org/wiki/Backpropagation">BP algorithm</a> for a feed-forward network.</p>

<h2 id="parallel-design">PARALLEL DESIGN</h2>

<ul>
<li><p>What are the model? What kind of data structure?</p>

<p>Weights matrices, including the biases for each node, between each adjacent layers are the model in neural network. It is a vector of double matrix.</p></li>

<li><p>What are the characteristics of the data dependency in model update computation, can updates run concurrently?</p>

<p>In the core model update computation in BP training algorithm, each data point, or a minibatch, should access all the model, compute gradients and update model layer by layer from the output layer back to the input layer.</p>

<p>The nodes in the same layer can be updated in parallel without conflicts, but there are dependency between the layers. But generally, it is not easy to utilize these network structure related parallelism.</p></li>

<li><p>which kind of parallelism scheme is suitable, data parallelism or model parallelism?</p>

<p>Data parallelism can be used, i.e., calculating different data points in parallel.</p>

<p>No model parallelism, each node get one replica of the whole model, which updates locally in parallel, and then synchronizes and averages when local computation all finish.</p></li>

<li><p>which collective communication operations is suitable to synchronize model?</p>

<p>Synchronize replicas of the model by allreduce is an simple solution.</p></li>
</ul>

<h2 id="dataflow">DATAFLOW</h2>

<p><img src="https://dsc-spidal.github.io/harp-test/img/nn-dataflow.png" width="60%"  ></p>

<h2 id="step-1-set-table">Step 1 &mdash; Set Table</h2>

<p>The data format wrapper code is in charge of the conversion between the native DoubleMatrix and Harp Table.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="n">Table</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="nf">train</span><span class="o">(</span><span class="n">DoubleMatrix</span> <span class="n">X</span><span class="o">,</span> <span class="n">DoubleMatrix</span> <span class="n">Y</span><span class="o">,</span> <span class="n">Table</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="n">localWeightTable</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mini_epochs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">numMapTasks</span><span class="o">,</span> <span class="kt">double</span> <span class="n">lambda</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span>
<span class="o">{</span>
    <span class="n">Vector</span><span class="o">&lt;</span><span class="n">DoubleMatrix</span><span class="o">&gt;</span> <span class="n">weightMatrix</span> <span class="o">=</span> <span class="n">reshapeTableToList</span><span class="o">(</span><span class="n">localWeightTable</span><span class="o">);</span>
    <span class="n">setTheta</span><span class="o">(</span><span class="n">weightMatrix</span><span class="o">);</span>

    <span class="n">trainBP</span><span class="o">(</span><span class="n">X</span><span class="o">,</span> <span class="n">Y</span><span class="o">,</span> <span class="n">lambda</span><span class="o">,</span> <span class="n">mini_epochs</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

    <span class="n">Table</span><span class="o">&lt;</span><span class="n">DoubleArray</span><span class="o">&gt;</span> <span class="n">newWeightTable</span> <span class="o">=</span> <span class="n">reshapeListToTable</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getTheta</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">newWeightTable</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="step-2-communication">Step 2 &mdash;Communication</h2>

<p>The code snippet for the core part of computation in the iterative training. There  are only a few lines of differences between the harp distributed version and the original sequential version.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="c1">// Calculate the new weights </span>
<span class="c1">// argument data type conversion and call the train() in the underlie library</span>
<span class="n">weightTable</span> <span class="o">=</span> <span class="n">localNN</span><span class="o">.</span><span class="na">train</span><span class="o">(</span><span class="n">X</span><span class="o">,</span> <span class="n">Y</span><span class="o">,</span> <span class="n">weightTable</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">numMapTasks</span><span class="o">,</span> <span class="n">lambda</span><span class="o">);</span>

<span class="c1">// reduce and broadcast</span>
<span class="n">allreduce</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">,</span> <span class="s">&quot;allreduce&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">weightTable</span><span class="o">);</span>

<span class="c1">// Average the weight table by the numMapTasks</span>
<span class="n">weightTable</span> <span class="o">=</span> <span class="n">localNN</span><span class="o">.</span><span class="na">modelAveraging</span><span class="o">(</span><span class="n">weightTable</span><span class="o">,</span> <span class="n">numMapTasks</span><span class="o">);</span>
</code></pre></div>

<h2 id="data">DATA</h2>

<p>The MNIST dataset is used in this tutorial. Refer the <a href="https://github.com/DSC-SPIDAL/harp/tree/master/data/tutorial/mnist">dataset script</a> for more details.</p>

<h2 id="usage">USAGE</h2>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ hadoop jar harp-tutorial-app-1.0-SNAPSHOT.jar edu.iu.NN.NNMapCollective
Usage: NNMapCollective &lt;number of map tasks&gt; &lt;epochs&gt; &lt;syncIterNum&gt; &lt;hiddenLayers&gt; &lt;minibatchsize&gt; &lt;lambda&gt; &lt;workDir&gt;
<span class="c1"># hadoop jar harp-tutorial-app-1.0-SNAPSHOT.jar edu.iu.NN.NNMapCollective 2 20 5 100,32 2000 0 /nn</span>
</code></pre></div>

<p>This command run harp neuralnetwork training on the input dataset under /nn, with 2 mappers. Training process goes through 20 times of the training dataset, averages the model every 5 iteration for each minibatch. The minibatch size is 2000, lambda is default value 0.689. There are 2 hidden layers, with 100 and 32 nodes each. Finally, it outputs the accuracy on the training set into the hadoop log.</p>
</article></section></div></div></div><script src="https://code.jquery.com/jquery-2.2.1.min.js"></script><script src="https://dsc-spidal.github.io/harp-test/js/app.min.js"></script></body></html>